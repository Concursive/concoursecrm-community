<!--
 $Id$

 Notes: 
   The easiest way to get started is to run "ant deploy"

   The build process will instruct you to have several environment variables
   and to customize the build.properties.  The build will fail until all
   installation conditions are met.
   
   Do not edit master.properties in this folder, a copy will be
   made by the installation and you will be notified of the file to modify.
   
   The build process needs write access to the destination web-app folder.
-->
<project name="Centric CRM" default="usage" basedir=".">
  
  <!-- enable environment variables -->
  <property environment="env"/>
  
  <!-- constants -->
  <property name="POSTGRESQL" value="postgresql"/>
  <property name="MSSQL" value="mssql"/>
  <property name="DAFFODILDB" value="daffodildb"/>

  <!-- computed properties -->
  <property name="fs" value="${file.separator}"/>
  <property name="lf" value="${line.separator}"/>
  <property name="base.dir" value="${basedir}"/>
  <property name="lib.dir" value="${base.dir}${fs}lib"/>
  <property name="src.dir" value="${base.dir}${fs}src"/>
  <property name="src.classes.dir" value="${src.dir}${fs}java"/>
  <property name="src.web.dir" value="${src.dir}${fs}web"/>
  <property name="src.sql.dir" value="${src.dir}${fs}sql"/>
  <property name="build.dir" value="${base.dir}${fs}build"/>
  <property name="build.lib.dir" value="${build.dir}${fs}lib"/>
  <property name="build.classes.dir" value="${build.dir}${fs}classes"/>
  <property name="build.jsp.dir" value="${build.dir}${fs}jsp"/>
  <property name="build.jspclasses.dir" value="${build.dir}${fs}jspclasses"/>
  <property name="build.sql.dir" value="${build.dir}${fs}sql"/>
  <property name="build.docs.dir" value="${build.dir}${fs}docs"/>
  <property name="build.pref.dir" value="${build.dir}${fs}pref"/>
  <property name="build.web.dir" value="${build.dir}${fs}web"/>
  <property name="pref.dir" value="${base.dir}${fs}pref"/>
  <property name="dist.dir" value="${base.dir}${fs}dist"/>
  
  <!-- Typical usage -->
  <target name="usage">
    <echo message="ant deploy: compile code and create .war file in dist directory"/>
    <echo message="ant copy: compile, build, and copy changed files for development"/>
    <echo message="ant installdb: install database schema into a new/clean database"/>
    <echo message="ant upgradesql: upgrades database with a specified .sql script file"/>
    <echo message="ant upgradebsh: upgrades database with a specified .bsh script file"/>
    <echo message="ant docs: generate JavaDocs for all packages"/>
    <echo message="ant clean: delete the temporary build folder used by the install"/>
  </target>
  
  <!-- Environment variables must be set before continuing -->
  <target name="init.environment">
    <tstamp><format property="date.short" pattern="yyyyMMdd-HHmmss"/></tstamp>
    <tstamp><format property="date.long" pattern="yyyy-MM-dd hh:mm:ss aa"/></tstamp>
    <!-- log the build -->
    <record name="${base.dir}/build.log" append="no"/>
    <fail unless="env.CATALINA_HOME">Initialization aborted ${lf}${lf}SOLUTION: Setup the environment variable CATALINA_HOME to point at your Tomcat installation.</fail>
    <property name="CATALINA_HOME" value="${env.CATALINA_HOME}"/>
    <property name="CRM_HOME" value="${env.CRM_HOME}"/>
  </target>
  
  <!-- See if servlet API file exists -->
  <target name="init.servlet4.exists" depends="init.environment">
    <available file="${CATALINA_HOME}/common/lib/servlet.jar" 
               property="build.servlet4.present"/>
  </target>
  <target name="init.servlet4.set" depends="init.servlet4.exists" if="build.servlet4.present">
    <property name="servletJar" value="${CATALINA_HOME}${fs}common${fs}lib${fs}servlet.jar"/>
    <echo message="Web Server: Tomcat 4.x"/>
  </target>
  <target name="init.servlet5.exists" depends="init.environment">
    <available file="${CATALINA_HOME}/common/lib/servlet-api.jar" 
               property="build.servlet5.present"/>
  </target>
  <target name="init.servlet5.set" depends="init.servlet5.exists" if="build.servlet5.present">
    <property name="servletJar" value="${CATALINA_HOME}${fs}common${fs}lib${fs}servlet-api.jar"/>
    <echo message="Web Server: Tomcat 5.x"/>
  </target>
  
  <!-- See if the properties file exists -->
  <target name="init.buildfile.exists" depends="init.environment">
    <available file="${base.dir}/build.properties" 
               property="build.config.present"/>
    <available file="${base.dir}/lib/mail.jar" 
               property="build.lib.present"/>
  </target>
  
  <!-- Create the properties file if not exists -->
  <target name="init.buildfile.create" depends="init.buildfile.exists" 
          unless="build.config.present">
    <copy file="${base.dir}/master.properties" 
          tofile="${base.dir}/build.properties"
          overwrite="false"/>
    <available file="${base.dir}/build.properties" property="build.config.present"/>
  </target>
  
  <!-- Load the properties for this system, stop here if not found -->
  <target name="init.loadproperties" depends="init.buildfile.create">
    <!-- IF src build.properties is newer than build.properties, abort now and have user update -->
    <uptodate property="build.config.uptodate"
            srcfile="${base.dir}/master.properties"
            targetfile="${base.dir}/build.properties"/>
    <fail unless="build.config.uptodate">Initialization aborted${lf}${lf}SOLUTION: Edit the build.properties file since it might be out of date.  Compare your copy with the source template, making any necessary changes, and save the file so it has a new modified date.${lf}${lf}Your File: ${base.dir}${fs}build.properties${lf}Source Template: master.properties</fail>
    <loadproperties srcFile="${base.dir}/build.properties">
      <filterchain>
        <filterreader classname="org.apache.tools.ant.filters.StripLineComments">
          <param type="comment" value="#"/>
        </filterreader>
      </filterchain>
    </loadproperties>
    <fail unless="build.lib.present">Initialization aborted ${lf}${lf}SOLUTION: Download the 3rd-party libraries and make sure they are available at ${lib.dir}${fs}, these are available as a separate download</fail>
    <fail unless="build.config.present">Initialization aborted ${lf}${lf}SOLUTION: Make sure this directory has permissions to write files, since the build properties file was not created at ${base.dir}${fs}build.properties</fail>
    <fail unless="CONTROL">Initialization aborted ${lf}${lf}SOLUTION: Edit the properties file at ${base.dir}${fs}build.properties, make sure to uncomment the control parameter at the top of the file</fail>
  </target>
  
  <!-- Copy the common jars -->
  <target name="init.classpath.uptodate">
    <mkdir dir="${CRM_HOME}/WEB-INF/lib"/>
    <copy todir="${CRM_HOME}/WEB-INF/lib">
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </copy>
  </target>

  <!-- Configure classpath as both object and a property -->
  <target name="init.classpath">
    <path id="cfs2.classpath">
      <fileset dir="${CATALINA_HOME}/common/lib">
        <include name="*.jar"/>
      </fileset>
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </path>
    <property name="CLASSPATH" refid="cfs2.classpath" />
  </target>
  
  <!-- Prepare ant for processing -->
  <target name="init" depends="init.loadproperties,init.classpath,init.servlet4.set,init.servlet5.set" 
    description="Verify system environment needed by install">
    <!-- Default properties if not otherwise specified in build.properties -->
    <property name="DEBUGLEVEL" value="none"/>
    <!-- Gatekeeper database -->
    <property name="GATEKEEPER.APPCODE" value=""/>
    <property name="GATEKEEPER.DBTYPE" value=""/>
    <property name="GATEKEEPER.DRIVER" value=""/>
    <property name="GATEKEEPER.URL" value=""/>
    <property name="GATEKEEPER.USER" value=""/>
    <property name="GATEKEEPER.PASSWORD" value=""/>
    <!-- Additional sites/databases -->
    <property name="SITE.APPCODE" value=""/>
    <property name="SITE.DBTYPE" value=""/>
    <property name="SITE.DRIVER" value=""/>
    <property name="SITE.URL" value=""/>
    <property name="SITE.APPEND" value=""/>
    <property name="SITE.USER" value=""/>
    <property name="SITE.PASSWORD" value=""/>
    <!-- External Servers -->
    <property name="MAILSERVER" value="127.0.0.1"/>
    <property name="FAXSERVER" value="127.0.0.1"/>
    
    <!-- Begin output -->
    <echo message="Project: ${ant.project.name}"/>
    <echo message="Date: ${date.long}"/>
    <echo message="User: ${user.name}"/>
    <echo message="System: ${os.name} ${os.arch} ${os.version}"/>
    <echo message="Ant version: ${ant.version}"/>
    <echo message="Java version: ${java.version}"/>
    <echo message="Source Path: ${base.dir}"/>
    <echo message="Destination Path: ${base.dir}"/>
  </target>
  
  <target name="taskdef.upgradeDatabase" depends="init">
    <taskdef name="upgradeDatabase" 
        classname="org.aspcfs.ant.tasks.UpgradeDatabaseTask">
        <classpath>
          <fileset dir="${build.lib.dir}">
            <include name="*.jar"/>
          </fileset>
          <fileset dir="${lib.dir}">
            <include name="*.jar"/>
          </fileset>
        </classpath>
    </taskdef>
  </target>
  
  <target name="taskdef.jasper" depends="init">
    <taskdef name="compileJasperReport" 
        classname="net.sf.jasperreports.ant.JRAntCompileTask">
        <classpath>
          <fileset dir="${build.lib.dir}">
            <include name="*.jar"/>
          </fileset>
          <fileset dir="${lib.dir}">
            <include name="*.jar"/>
          </fileset>
        </classpath>
    </taskdef>
  </target>

  <target name="confirm.directory">
    <fail unless="CRM_HOME">Initialization aborted ${lf}${lf}SOLUTION: Create an environment variable CRM_HOME which points to Tomcat's Centric CRM webapp directory.  Ex. "CRM_HOME=/path/to/tomcat/webapps/centric"</fail>
  </target>

  <!-- See if files are up-to-date so only new files are installed during development -->
  <target name="classes.prepare" depends="init, confirm.directory">
    <uptodate property="classes.uptodate">
      <srcfiles dir="${src.classes.dir}" includes="**/*.java"/>
      <mapper type="merge" to="${CRM_HOME}/WEB-INF/lib/aspcfs.jar"/>
    </uptodate>
  </target>
  
  <!-- Check to see if previously compiled classes should be deleted -->
  <target name="compile.checkdelete" depends="init">
    <condition property="compile.donotdelete">
      <isset property="classes.uptodate"/>
    </condition>
    <condition property="compile.donotdelete">
      <and>
        <not>
          <isset property="classes.uptodate"/>
        </not>
        <isset property="compile.donotdelete.property"/>
      </and>
    </condition>
  </target>
  
  <target name="compile.delete"
          depends="init,compile.checkdelete"
          unless="compile.donotdelete">
    <!-- Get rid of any classes in the source dir that shouldn't be there -->
    <delete>
        <fileset dir= "${src.classes.dir}" includes="**/*.class"/>
    </delete>
    <delete dir="${build.classes.dir}"/>
    <mkdir dir="${build.classes.dir}"/>
  </target>
  
  <!-- Compile the Java source code -->
  <target name="compile" 
          description="Compile all .java source files"
          depends="init,compile.delete"
          unless="classes.uptodate">
    <!-- Compile the code -->
    <javac srcdir="${src.classes.dir}" destdir="${build.classes.dir}" verbose="off" deprecation="off"
        fork="true" memoryInitialSize="168m" memoryMaximumSize="168m">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
    </javac>
  </target>
  
  <!-- Generate the .jar files -->
  <target name="jar" 
          depends="init"
          unless="classes.uptodate">
    <delete dir="${build.lib.dir}"/>
    <mkdir dir="${build.lib.dir}"/>
    <!-- darkhorseventures.jar -->
    <jar jarfile="${build.lib.dir}/darkhorseventures.jar"
          basedir="${build.classes.dir}"
          includes="com/darkhorseventures/**/*.class"/>
    <!-- isavvix.jar -->
    <jar jarfile="${build.lib.dir}/isavvix.jar"
          basedir="${build.classes.dir}"
          includes="com/isavvix/**/*.class"/>
    <!-- zeroio-iteam.jar -->
    <jar jarfile="${build.lib.dir}/zeroio-iteam.jar"
          basedir="${build.classes.dir}"
          includes="com/zeroio/**/*.class"/>
    <!-- aspcfs.jar -->
    <jar jarfile="${build.lib.dir}/aspcfs.jar"
          basedir="${build.classes.dir}"
          includes="org/aspcfs/**/*.class"/>
    <!-- jcrontab.jar -->
    <jar jarfile="${build.lib.dir}/jcrontab.jar"
          basedir="${build.classes.dir}"
          includes="org/jcrontab/**/*.class"/>
    <!-- webdav.jar -->
    <copy todir="${build.classes.dir}/org/apache/catalina/servlets">
      <fileset dir="${src.classes.dir}/org/apache/catalina/servlets">
        <include name="LocalStrings.properties"/>
      </fileset>
    </copy>
    <jar jarfile="${build.lib.dir}/webdav.jar"
          basedir="${build.classes.dir}"
          includes="org/apache/**/*.class,org/apache/**/*.properties"/>
  </target>
  
  <target name="build"
          description="Create .jar files for compiled classes"
          depends="init,compile,jar">
    <mkdir dir="${build.lib.dir}"/>
  </target>

  <!-- Delete outdated files -->
  <target name="deploy.delete" depends="confirm.directory" description="Removes outdated files from web application">
    <delete verbose="true" >
      <fileset dir="${CRM_HOME}" includesfile="${base.dir}/build.cleanup"/>
    </delete>
  </target>

  <target name="deploy.copy" depends="confirm.directory">
    <!-- Copy the .jars, only if new -->
    <copy todir="${CRM_HOME}/WEB-INF/lib">
      <fileset dir="${build.lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </copy>
    <!-- Copy the web data, only if new -->
    <copy todir="${CRM_HOME}">
      <fileset dir="${src.web.dir}/jsp">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${CRM_HOME}">
      <fileset dir="${src.web.dir}/html">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${CRM_HOME}" >
      <fileset dir="${src.web.dir}">
        <include name="images/**" />
        <include name="javascript/**" />
        <include name="css/**" />
      </fileset>
    </copy>
    <!-- Copy the configuration files -->
    <copy todir="${CRM_HOME}/WEB-INF" verbose="true">
      <fileset dir="${src.web.dir}/WEB-INF">
        <include name="*.xml"/>
        <include name="*.tld"/>
        <exclude name="web.xml"/>
      </fileset>
    </copy>
    <!-- Copy the language files -->
    <mkdir dir="${CRM_HOME}/WEB-INF/languages"/>
    <copy todir="${CRM_HOME}/WEB-INF/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${CRM_HOME}/javascript/languages"/>
    <copy todir="${CRM_HOME}/javascript/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.js"/>
      </fileset>
    </copy>
    <!-- Copy the font files-->
    <mkdir dir="${CRM_HOME}/WEB-INF/fonts"/>
    <copy todir="${CRM_HOME}/WEB-INF/fonts">
      <fileset dir="${src.dir}/fonts">
        <include name="*.ttf"/>
      </fileset>
    </copy>
    <!-- Copy this build file -->
    <copy file="${base.dir}/build.xml" todir="${CRM_HOME}/WEB-INF/fileLibrary" verbose="true"/>
  </target>

  <target name="deploy.jasper.check" depends="init">
    <uptodate property="deploy.jasper.uptodate">
      <srcfiles dir="${src.dir}/jasper_reports" includes="*.xml"/>
      <mapper type="merge" to="${CRM_HOME}/WEB-INF/reports/accounts_type.jasper"/>
    </uptodate>
  </target>

  <target name="deploy.jasper" depends="confirm.directory,deploy.jasper.check,taskdef.jasper" unless="deploy.jasper.uptodate">
    <echo message="Installing JasperReport files"/>
    <!-- Copy the jasperreports, only if new -->
    <copy todir="${CRM_HOME}/WEB-INF/reports">
      <fileset dir="${src.dir}/jasper_reports">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <!-- The old .jasper file must be removed when a new .xml is copied -->
    <delete>
        <fileset dir= "${CRM_HOME}/WEB-INF/reports" includes="*.jasper"/>
    </delete>
    <!-- Compile the reports -->
    <compileJasperReport
        srcdir="${CRM_HOME}/WEB-INF/reports"
        destdir="${CRM_HOME}/WEB-INF/reports"
        compiler="net.sf.jasperreports.engine.design.JRBshCompiler"/>
  </target>

  <!-- See if there is an updated file to merge -->
  <target name="deploy.merge.prepare">
    <!-- Generate a new CRM_HOME web.xml if any of the following: -->
    <!-- 1. cvs web.xml is newer than CRM_HOME web.xml -->
    <!-- 2. CRM_HOME build.properties is newer than CRM_HOME web.xml -->
    <!-- 3. Any of the CRM_HOME xml or tld files are newer than CRM_HOME web.xml -->
    <condition property="deploy.merge.uptodate">
      <and>
        <available file="${CRM_HOME}/WEB-INF/web.xml"/>
        <available file="${CRM_HOME}/WEB-INF/fileLibrary/build.properties"/>
        <uptodate srcfile="${src.web.dir}/WEB-INF/web.xml"
                  targetfile="${CRM_HOME}/WEB-INF/web.xml"/>
        <uptodate srcfile="${CRM_HOME}/WEB-INF/fileLibrary/build.properties"
                  targetfile="${CRM_HOME}/WEB-INF/web.xml"/>
        <uptodate targetfile="${CRM_HOME}/WEB-INF/web.xml">
          <srcfiles dir="${CRM_HOME}/WEB-INF" includes="*.xml,*.tld" excludes="web.xml"/>
        </uptodate>
      </and>
    </condition>
  </target>

  <!-- Merge meta-data with build.properties, only if changed so reload doesn't kick in -->
  <target name="deploy.merge" depends="confirm.directory,deploy.merge.prepare" unless="deploy.merge.uptodate">
    <echo message="Installing web.xml configuration file"/>
    <copy file="${src.web.dir}/WEB-INF/web.xml" todir="${CRM_HOME}/WEB-INF" overwrite="true"/>
    <replace file="${CRM_HOME}/WEB-INF/web.xml"
             token="@KEYSTORE@" value="${CRM_HOME}${fs}WEB-INF${fs}fileLibrary${fs}keystore"/>
  </target>

  <!-- Deploy to an exploded web application directory -->
  <target name="copy"
          description="Compile, build, copy, and configure web application"
          depends="init,confirm.directory,classes.prepare,build,deploy.delete,deploy.copy,deploy.merge,deploy.jasper">
    <mkdir dir="${CRM_HOME}/graphs"/>
  </target>

  <target name="dev.configure">
    <property name="compile.donotdelete.property" value="true"/>
  </target>

  <!-- Create a WAR -->
  <target name="deploy"
          description="Compile, build, and generate web archive"
          depends="build,dist.archive">
  </target>
  
  <target name="dist.archive" depends="taskdef.jasper">
    <delete dir="${dist.dir}"/>
    <mkdir dir="${dist.dir}"/>
    <!-- Copy the common .jars -->
    <copy todir="${dist.dir}/cfs/WEB-INF/lib">
      <fileset dir="${lib.dir}">
        <include name="*.jar"/>
      </fileset>
    </copy>
    <!-- Copy the .jars -->
    <copy todir="${dist.dir}/cfs/WEB-INF/lib">
      <fileset dir="${build.lib.dir}">
        <include name="*.jar"/>
        <exclude name="aspcfs.jar"/>
      </fileset>
    </copy>
    <!-- aspcfs.jar -->
    <jar jarfile="${dist.dir}/cfs/WEB-INF/lib/aspcfs.jar"
          basedir="${build.classes.dir}"
          includes="org/aspcfs/**/*.class"
    />
    <!-- Copy the web data -->
    <copy todir="${dist.dir}/cfs">
      <fileset dir="${src.web.dir}/jsp">
        <include name="**"/>
      </fileset>
    </copy>
    <copy todir="${dist.dir}/cfs">
      <fileset dir="${src.web.dir}/html">
        <include name="**" />
      </fileset>
    </copy>
    <copy todir="${dist.dir}/cfs">
      <fileset dir="${src.web.dir}">
        <include name="images/**" />
        <include name="javascript/**" />
        <include name="css/**" />
      </fileset>
    </copy>
    <!-- Copy the configuration files -->
    <copy todir="${dist.dir}/cfs/WEB-INF" verbose="true">
      <fileset dir="${src.web.dir}/WEB-INF">
        <include name="*.xml"/>
        <include name="*.tld"/>
        <exclude name="web.xml"/>
      </fileset>
    </copy>
    <!-- Copy the default preference files -->
    <copy todir="${dist.dir}/cfs/WEB-INF/setup" verbose="true">
      <fileset dir="${pref.dir}/cfs/system">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <!-- Copy and compile the reports -->
    <mkdir dir="${dist.dir}/cfs/WEB-INF/reports"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/reports">
      <fileset dir="${src.dir}/jasper_reports">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <compileJasperReport
        srcdir="${dist.dir}/cfs/WEB-INF/reports"
        destdir="${dist.dir}/cfs/WEB-INF/reports"
        compiler="net.sf.jasperreports.engine.design.JRBshCompiler"/>
    <delete>
        <fileset dir= "${dist.dir}/cfs/WEB-INF/reports" includes="*.xml"/>
    </delete>
    <!-- Copy the language files -->
    <mkdir dir="${dist.dir}/cfs/WEB-INF/languages"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <mkdir dir="${dist.dir}/cfs/javascript/languages"/>
    <copy todir="${dist.dir}/cfs/javascript/languages">
      <fileset dir="${src.dir}/languages">
        <include name="*.js"/>
      </fileset>
    </copy>
    <!-- Copy the fonts -->
    <mkdir dir="${dist.dir}/cfs/WEB-INF/fonts"/>
    <copy todir="${dist.dir}/cfs/WEB-INF/fonts">
      <fileset dir="${src.dir}/fonts">
        <include name="*.ttf"/>
      </fileset>
    </copy>
    <!-- Archive the folder -->
    <war destfile="${dist.dir}/centric.war"
         webxml="${src.web.dir}/WEB-INF/web.xml"
         basedir="${dist.dir}/cfs"
         compress="true"
         manifest="${pref.dir}/cfs/war/MANIFEST.MF"
         />
    <!-- Cleanup files -->
    <delete dir="${dist.dir}/cfs"/>
    <echo message=".war file created: ${dist.dir}${fs}centric.war"/>
  </target>
  
  <!-- Remove the build folder -->
  <target name="clean"
          description="Delete the temporary build folder used by the install"
          depends="init">
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
  </target>
  
  <target name="install.prepare.dbname" unless="DATABASE.NAME">
    <!-- Ask for the database name -->
    <input message="Enter database name: " addproperty="DATABASE.NAME"/>
    <!-- Display all information about database here, except password -->
    <echo message="Driver: ${SITE.DRIVER}"/>
    <echo message="URL: ${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
    <echo message="Username: ${SITE.USER}"/>
  </target>
  
  <!-- Prepare files for any database type -->
  <target name="install.prepare.init" depends="init,install.prepare.dbname">
    <!-- Verify database can be overwritten -->
    <input message="The database '${DATABASE.NAME}' will be modified and must already exist, continue? "
           validargs="y,n"
           addproperty="DATABASE.DELETE"/>
    <condition property="ABORT">
      <equals arg1="n" arg2="${DATABASE.DELETE}"/>
    </condition>
    <fail if="ABORT">Build aborted by user.</fail>
    <!-- Determine the database to execute the compatible tasks -->
    <condition property="DBTYPE.POSTGRESQL">
      <equals arg1="${SITE.DBTYPE}" arg2="${POSTGRESQL}" casesensitive="false" trim="true"/>
    </condition>
    <condition property="DBTYPE.MSSQL">
      <equals arg1="${SITE.DBTYPE}" arg2="${MSSQL}" casesensitive="false" trim="true"/>
    </condition>
    <condition property="DBTYPE.DAFFODILDB">
      <equals arg1="${SITE.DBTYPE}" arg2="${DAFFODILDB}" casesensitive="false" trim="true"/>
    </condition>
    <!-- Copy template files to be used -->
    <delete dir="${build.sql.dir}" failonerror="false"/>
    <mkdir dir="${build.sql.dir}"/>
    <copy todir="${build.sql.dir}">
      <fileset dir="${src.sql.dir}/init">
        <include name="*.sql" />
      </fileset>
    </copy>
  </target>
  
  <!-- Prepare the PostgreSQL files -->
  <target name="install.check.postgresql" depends="install.prepare.init" if="DBTYPE.POSTGRESQL">
    <replace dir="${build.sql.dir}" token="@TRUE@" value="true">
      <include name="*.sql"/>
    </replace>
    <replace dir="${build.sql.dir}" token="@FALSE@" value="false">
      <include name="*.sql"/>
    </replace>
  </target>
  
  <!-- Prepare the MicrosoftSQL files -->
  <target name="install.check.mssql" depends="install.prepare.init" if="DBTYPE.MSSQL">
    <replace dir="${build.sql.dir}" token="@TRUE@" value="1">
      <include name="*.sql"/>
    </replace>
    <replace dir="${build.sql.dir}" token="@FALSE@" value="0">
      <include name="*.sql"/>
    </replace>
  </target>
  
  <!-- Prepare the DaffodilDB files -->
  <target name="install.check.daffodildb" depends="install.prepare.init" if="DBTYPE.DAFFODILDB">
    <replace dir="${build.sql.dir}" token="@TRUE@" value="true">
      <include name="*.sql"/>
    </replace>
    <replace dir="${build.sql.dir}" token="@FALSE@" value="false">
      <include name="*.sql"/>
    </replace>
  </target>

  <target name="install.abortOnDB">
    <condition property="ABORT">
      <equals arg1="${SITE.DBTYPE}" arg2="${DAFFODILDB}" casesensitive="false" trim="true"/>
    </condition>
    <fail if="ABORT">This database type requires additional ant installdb commands.${lf}${lf}SOLUTION: Now execute "ant installdb${INSTALL.NEXT_ID}"</fail>
  </target>

  <target name="install.prepare" depends="install.check.postgresql,install.check.mssql,install.check.daffodildb">
    <echo message="SQL files prepared for database type: ${SITE.DBTYPE}"/>
  </target>
  
  <target name="install.database" depends="init,install.prepare,install.prepare.dbname,install.language">
    <property name="INSTALL.NEXT_ID" value="2"/>
    <echo message="Building database"/>
    <!-- TODO: Optionally create database -->
    
    <!-- Create database and initialize data -->
    <sql
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        userid="${SITE.USER}"
        password="${SITE.PASSWORD}">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
      <!-- base data -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_gatekeeper.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_cdb.sql"/>
      <!-- opportunities -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_opportunity.sql"/>
      <!-- project management -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_project.sql"/>
      <!-- product catalog -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_product.sql"/>
      <!-- service contracts and assets -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_service_contract.sql"/>
      <!-- tickets -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_tms.sql"/>
      <!-- quotes, orders -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_quote.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_order.sql"/>
      <!-- custom fields -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_custom_field.sql"/>
      <!-- communications manager -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_campaign.sql"/>
      <!-- help -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_help.sql"/>
      <!-- synchronization api -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_sync.sql"/>
      <!-- revenue manager -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_revenue.sql"/>
      <!-- task management -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_task.sql"/>
      <!-- document management -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_documents.sql"/>
      <!-- framework data -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_workflow.sql"/>
      <!-- additional fields -->
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_tms_append_fields.sql"/>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_quote_adjustment.sql" />
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_history.sql" />
    </sql>
    <delete dir="${build.sql.dir}" failonerror="false"/>
  </target>
  
  <!-- Insert required default data -->
  <target name="install.system" depends="init,taskdef.upgradeDatabase,install.prepare.dbname,install.language">
    <property name="INSTALL.NEXT_ID" value="3"/>
    <upgradeDatabase
      sitecode="${SITE.APPCODE}"
      driver="${SITE.DRIVER}"
      url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
      user="${SITE.USER}"
      password="${SITE.PASSWORD}"
      servletJar="${servletJar}"
      webPath="${CRM_HOME}"
      baseFile="${src.sql.dir}${fs}init${fs}database.bsh"
      specificDatabase="${DATABASE.NAME}"
      processSpecifiedDatabaseOnly="true">
    </upgradeDatabase>
    <upgradeDatabase
      sitecode="${SITE.APPCODE}"
      driver="${SITE.DRIVER}"
      url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
      user="${SITE.USER}"
      password="${SITE.PASSWORD}"
      servletJar="${servletJar}"
      webPath="${CRM_HOME}"
      baseFile="${src.sql.dir}${fs}init${fs}sync.bsh"
      specificDatabase="${DATABASE.NAME}"
      processSpecifiedDatabaseOnly="true">
    </upgradeDatabase>
  </target>

  <!-- Install permissions -->
  <target name="install.permissions" depends="init,install.prepare.dbname,install.language">
    <echo message="Process file: ${src.sql.dir}${fs}init${fs}permissions_${LOCALE.NAME}.xml"/>
    <java classname="org.aspcfs.apps.transfer.Transfer" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <sysproperty key="processConfigFile" value="${src.sql.dir}${fs}init${fs}permissions_${LOCALE.NAME}.xml"/>
      <sysproperty key="driver" value="${SITE.DRIVER}"/>
      <sysproperty key="url" value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <sysproperty key="user" value="${SITE.USER}"/>
      <sysproperty key="pass" value="${SITE.PASSWORD}"/>
      <arg value="${src.sql.dir}${fs}init${fs}permissions-dataimport.xml"/>
    </java>
  </target>
  
  
  <!-- Upgrade help contents by deleting all help and then inserting -->
  <target name="upgradedb.help" depends="init,install.prepare,install.deletehelp,install.help"/>
  
  <!-- Upgrade help contents by deleting all help and then inserting -->
  <target name="install.deletehelp" depends="init,install.prepare">
    <echo message="Deleting existing help contents..."/>
    <!-- Delete the old help -->
    <sql
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        userid="${SITE.USER}"
        password="${SITE.PASSWORD}">
      <classpath>
        <path refid="cfs2.classpath"/>
      </classpath>
      <transaction>DROP TABLE help_tips;</transaction>
      <transaction>DROP TABLE help_notes;</transaction>
      <transaction>DROP TABLE help_business_rules;</transaction>
      <transaction>DROP TABLE help_faqs;</transaction>
      <transaction>DROP TABLE help_related_links;</transaction>
      <transaction>DROP TABLE help_features;</transaction>
      <transaction>DROP TABLE lookup_help_features;</transaction>
      <transaction>DROP TABLE help_tableofcontentitem_links;</transaction>
      <transaction>DROP TABLE help_tableof_contents;</transaction>
      <transaction>DROP TABLE help_contents;</transaction>
      <transaction>DROP TABLE help_module;</transaction>
      <transaction src="${src.sql.dir}/${SITE.DBTYPE}/new_help.sql"/>
    </sql>
  </target>
  
  <!-- Install help contents into blank database -->
  <target name="install.help" depends="init,install.prepare.dbname,install.language">
    <echo message="Installing help contents from: ${src.sql.dir}${fs}init${fs}help.xml"/>
    <java classname="org.aspcfs.apps.help.ImportHelp" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <arg value="${src.sql.dir}${fs}init${fs}help.xml"/>
      <arg value="${SITE.DRIVER}"/>
      <arg value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <arg value="${SITE.USER}"/>
      <arg value="${SITE.PASSWORD}"/>
    </java>
  </target>

  <target name="install.language" unless="LOCALE.NAME">
    <!-- Ask for the language -->
    <echo message="Only available locales can be selected..."/>
    <input message="Which locale should be used for the data? "
           addproperty="LOCALE.NAME"
           validargs="de_DE,en_US,es_VE,pt_BR"/>
  </target>

  <target name="install.lookup" depends="init,install.prepare.dbname,install.language">
    <echo message="Installing lookuplists: ${build.web.dir}${fs}WEB-INF${fs}fileLibrary${fs}${DATABASE.NAME}${fs}lookuplists_${LOCALE.NAME}.xml"/>
    <mkdir dir="${build.web.dir}/WEB-INF/fileLibrary/${DATABASE.NAME}"/>
    <copy todir="${build.web.dir}/WEB-INF/fileLibrary/${DATABASE.NAME}">
      <fileset dir="${pref.dir}/cfs/system">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <java classname="org.aspcfs.apps.lookuplists.ImportLookupLists" fork="yes" failonerror="yes">
      <classpath>
        <path refid="cfs2.classpath"/>
        <fileset dir="${build.lib.dir}">
          <include name="*.jar"/>
        </fileset>
      </classpath>
      <arg value="${build.web.dir}/WEB-INF/fileLibrary/${DATABASE.NAME}/lookuplists_${LOCALE.NAME}.xml"/>
      <arg value="${SITE.DRIVER}"/>
      <arg value="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"/>
      <arg value="${SITE.USER}"/>
      <arg value="${SITE.PASSWORD}"/>
    </java>
  </target>

  <!-- Copy the default .XML preferences for this system -->
  <target name="install.copyprefs" depends="init,taskdef.upgradeDatabase,install.prepare.dbname,install.language">
    <mkdir dir="${build.web.dir}/WEB-INF/fileLibrary/${DATABASE.NAME}"/>
    <copy todir="${build.web.dir}/WEB-INF/fileLibrary/${DATABASE.NAME}">
      <fileset dir="${pref.dir}/cfs/system">
        <include name="*.xml"/>
      </fileset>
    </copy>
    <!-- Install the workflow.xml to the database -->
    <upgradeDatabase
        sitecode="${SITE.APPCODE}"
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        user="${SITE.USER}"
        password="${SITE.PASSWORD}"
        servletJar="${servletJar}"
        webPath="${build.web.dir}${fs}"
        baseFile="${src.sql.dir}${fs}init${fs}workflow.bsh"
        specificDatabase="${DATABASE.NAME}"
        processSpecifiedDatabaseOnly="true"
        locale="${LOCALE.NAME}">
    </upgradeDatabase>
  </target>
  <!-- Delete the preferences from this system -->
  <target name="install.deleteprefs" depends="init,taskdef.upgradeDatabase,install.prepare.dbname,install.language">
    <!-- Delete the workflow from the database -->
    <upgradeDatabase
        sitecode="${SITE.APPCODE}"
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        user="${SITE.USER}"
        password="${SITE.PASSWORD}"
        servletJar="${servletJar}"
        webPath="${build.web.dir}${fs}"
        baseFile="${src.sql.dir}${fs}init${fs}workflow-delete.bsh"
        specificDatabase="${DATABASE.NAME}"
        processSpecifiedDatabaseOnly="true">
    </upgradeDatabase>
  </target>
  <!-- Copy the default .XML preferences for this system -->
  <target name="install.events" depends="init,taskdef.upgradeDatabase,install.prepare.dbname,install.language">
    <!-- Install the default events to the database -->
    <upgradeDatabase
        sitecode="${SITE.APPCODE}"
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        user="${SITE.USER}"
        password="${SITE.PASSWORD}"
        servletJar="${servletJar}"
        webPath="${build.web.dir}"
        baseFile="${src.sql.dir}${fs}init${fs}events_gk.bsh"
        specificDatabase="${DATABASE.NAME}"
        processSpecifiedDatabaseOnly="true"
        locale="${LOCALE.NAME}">
    </upgradeDatabase>
  </target>

  <!-- Installs a new database -->
  <target name="installdb" depends="install.database,install.abortOnDB,install.system,install.permissions,install.lookup,install.help,install.copyprefs,install.events"
    description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>
  <!-- Embedded DB currently locks database so run these separately -->
  <target name="installdb2" depends="install.system,install.abortOnDB"
    description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>
  <target name="installdb3" depends="install.permissions,install.lookup,install.help,install.copyprefs,install.events"
    description="Create tables, insert base records and permissions into new database, copy XML files">
  </target>

  <!-- Programmatically upgrades installed databases for
       the specified appcode and file, runs against the build code,
       not the installed code so that scripts can be run before OR after
       a site has been deployed -->
  <target name="upgradedb.name" unless="arg1">
    <input message="Enter file to process, include the file extension: " addproperty="arg1"/>
  </target>
  <target name="upgradedb.site" unless="arg2">
    <input message="Enter database to upgrade: " addproperty="arg2"/>
  </target>
  <target name="upgradedb.uptodate">
    <uptodate property="classes.uptodate">
      <srcfiles dir="${src.classes.dir}" includes="**/*.java"/>
      <mapper type="merge" to="${build.lib.dir}/aspcfs.jar"/>
    </uptodate>
  </target>
  <target name="upgradesql" depends="taskdef.upgradeDatabase,taskdef.jasper,upgradedb.name,upgradedb.site,upgradedb.uptodate,build"
    description="Upgrades database with a specified .sql script file">
    <fail unless="arg1">Missing arg1 -- the file to process</fail>
    <fail unless="arg2">Missing arg2 -- the database to upgrade</fail>
    <upgradeDatabase
        sitecode="${SITE.APPCODE}"
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        user="${SITE.USER}"
        password="${SITE.PASSWORD}"
        servletJar="${servletJar}"
        webPath="${build.web.dir}"
        baseFile="${src.sql.dir}${fs}${SITE.DBTYPE}${fs}upgrade${fs}${arg1}"
        specificDatabase="${DATABASE.NAME}"
        processSpecifiedDatabaseOnly="true"
        locale="${LOCALE.NAME}">
    </upgradeDatabase>
  </target>
  <target name="upgradebsh" depends="taskdef.upgradeDatabase,taskdef.jasper,upgradedb.name,upgradedb.site,upgradedb.uptodate,build"
    description="Upgrades database with a specified .bsh script file">
    <fail unless="arg1">Missing arg1 -- the file to process</fail>
    <fail unless="arg2">Missing arg2 -- the database to upgrade</fail>
    <upgradeDatabase
        sitecode="${SITE.APPCODE}"
        driver="${SITE.DRIVER}"
        url="${SITE.URL}${DATABASE.NAME}${SITE.APPEND}"
        user="${SITE.USER}"
        password="${SITE.PASSWORD}"
        servletJar="${servletJar}"
        webPath="${build.web.dir}"
        baseFile="${src.sql.dir}${fs}upgrade${fs}${arg1}"
        specificDatabase="${DATABASE.NAME}"
        processSpecifiedDatabaseOnly="true"
        locale="${LOCALE.NAME}">
    </upgradeDatabase>
  </target>

  <!-- Generate Java Docs -->
  <target name="docs" description="Generate JavaDocs" depends="compile">
    <mkdir dir="${build.docs.dir}"/>
    <javadoc sourcepath="${src.classes.dir}"
          packagenames="com.*,org.*"
          destdir="${build.docs.dir}"
          maxmemory="128m"
          breakiterator="true"
          author="true"
          version="true"
          excludepackagenames="javax.servlet">
      <tag name="created" description="Date file was created"/>
      <header>Centric CRM</header>
      <footer>Copyright 2001-2005 Dark Horse Ventures, LLC</footer>
      <classpath>
        <path refid="cfs2.classpath"/>
        <!--
        <pathelement location="${SRC_LIB}/aspcfs.jar"/>
        -->
      </classpath>
    </javadoc>
  </target>
  
</project>
