/**
 *  Client/Server Synchronization (DRAFT)
 *
 *@author     mrajkowski
 *@created    April 16, 2002
 *@version    $Id$
 */

This protocol requires that the server and each client are able to keep 
track of changes that have happened between synchronizations. 

To specify the changed data items, unique identifiers are used per client.
Any data added to the client will use an identity that is unique to that
client only.  The server will need to manage the differences between clients
and make sure the IDs used on each client map correctly to the data stored
on the server.  When the server sends new data to the client, the client will
need to specify an ID to begin with.

To indicate the type of modification, different actions are specified within
a transaction.  Actions include: insert, update, delete, and sync.

Sync anchors are used to enable sanity checks for synchronization. A sync anchor 
is a date/time when the last synchronization was completed, stored on both 
the client and server.  These must match for the systems to be in sync.

In this approach, the client drives the whole synchronization process.

The client will be responsible for specifying the order of synchronization events
based on the sync table.

When data is being transferred, a limit needs to be specified by the client so 
that the server does not send too many records back to the client in a single 
transaction.  Some clients can handle an enormous amount of data, while handhelds
cannot.

  

The synchronization process:

---[ INITIATE DATA SYNCHRONIZATION ]---

Client #1 Configures its internal clock
- Client sends transaction to get the time
- This will be used as the "nextAnchor" for the current session of transactions
- An XML record is returned with a field called "dateTime"
  Ex. "2002-05-28 16:34:20.167"

<?xml version="1.0" standalone="yes"?>
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
  </authentication>
  <transaction id="2">
    <syncClient action="getDateTime"/>
  </transaction>
</app>


Client #1 Logs into the server
- Client sends transaction with username and password


Client #1 Registers its device
- Client sends transaction with device registration information


Client #1 Prepares for Synchronization
- Client reads local Sync Anchor (Last Anchor) from internal database
  Initially the anchor is null, but will be a date/time in future syncs
- Client sends transaction to find out if synchronization is ok

<?xml version="1.0" standalone="yes"?>
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>*PUT CLIENT ID HERE*</clientId>
    <lastAnchor/>
    <nextAnchor>2002-04-20 15:30:30</nextAnchor>
  </authentication>
  <transaction id="4">
    <syncClient action="syncStart"/>
  </transaction>
</app>

- Server compares anchors, if not a match then a previous synchronization error
  may have occurred, returns error response

---[ BEGIN CLIENT DATA SYNCHRONIZATION ]---
All changes can be requested and sent in a single transaction, or separated.  
The order in which tables are processed is important for referential data.
Initially the client will not have any data to send, it will need to load
all data.  If it has data, then it can do inserts, updates, and deletes.
Deletes need to be done from the last table synchronized instead of the first.
Look at the object-XML-mapping document for details on specific objects.

Client #1 Sends records for insert with GUID... one or all records
- Client sends transaction and command in body
- Server looks in mapping table, if GUID does not exist then continues
- Server inserts item into corresponding table
- Server inserts GUID, tableId, and recordId into client mapping table
   clientId | GUID | tableId | RecordId
- Server responds with success

Client #1 Sends records for update with GUID... one or all records
- Client sends transaction and command in body
- Server looks up ClientId and GUID to get RecordId to be updated
- Server sets the RecordId of the record
- Server updates the record
- Server responds with success

Client #1 Sends records for delete with GUID...
- Client sends transaction and command in body
- Server looks up ClientId and GUID to get RecordId to be deleted
- Server sets the RecordId of the record
- Server deletes the record
- Server deletes the ClientId/GUID record in client mapping table
- Server responds with success

---[ BEGIN SERVER DATA SYNCHRONIZATION ]---
All changes can be requested and sent in a single transaction, or separated.  
The order in which tables are processed is important for referential data.

** UPDATED PROCESS 4/19/2002 **

Client #1 Either requests a list of tables to be synchronized, or
iterates through its cached table list from the database initialization
- Client sends Last Anchor and Next Anchor to server in authentication block
- Client sends transaction and command in body, along with start ID, offset, 
and limit.
- Server determines the updates, inserts, and deletes for the specified table
- Server sends record(s) to client with appropriate command and GUID
- Server inserts GUID into client mapping table (if not already there)
- Client processes the received data, performing the appropriate SQL
- Client sends next table to be synchronized

<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>*INSERT CLIENT ID*</clientId>
    <lastAnchor>*INSERT LAST ANCHOR OR NULL</lastAnchor>
    <nextAnchor>*INSERT NEXT ANCHOR HERE*</nextAnchor>
  </authentication>
  <transaction id="10">
    <meta>
      <property>guid</property>
      <property>name</property>
      <property>enteredBy</property>
      <property>modified</property>
      <property>modifiedBy</property>
    </meta>
    <makeList action="sync" identity="1" offset="0" items="100"/>
  </transaction>
</app>

---[ FINALIZE DATA SYNCHRONIZATION ]---

Client #1 Ends Synchronization
- Client sets Sync Anchor to Next Anchor in local System table
- Client updates Anchor on Server with Next Anchor command
- Server deletes records flagged in client mapping table since they should
  no longer be on the client

  
Sync protocol:

getTime
  <time>  set your nextAnchor to this
  
syncClient action="syncStart"
  lastAnchor
  
<object> action="sync"
  previousAnchor
  nextAnchor

<object> action="insert"
<object> action="update"


syncClient action="syncEnd"
  nextAnchor
  
...Client needs to make sure it's internal clock is set correctly:

<?xml version="1.0" standalone="yes"?>
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>1</clientId>
    <lastAnchor/>
    <nextAnchor>2002-04-20 15:30:30</nextAnchor>
  </authentication>
  <transaction id="5">
    <meta>
      <property>dateTime</property>
    </meta>
    <syncClient action="getDateTime"/>
  </transaction>
</app>

...Client verifies sync mode:

<?xml version="1.0" standalone="yes"?>
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>1</clientId>
    <lastAnchor/>
    <nextAnchor>2002-04-20 15:30:30</nextAnchor>
  </authentication>
  <transaction id="5">
    <syncClient action="syncStart"/>
  </transaction>
</app>

...If error, client will need to resync all data...tbd,
...else continue with sync

...Client syncs tables from internal list of tables

<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>93</clientId>
    <lastAnchor/>
    <nextAnchor>2002-5-2 20:12:26</nextAnchor>
  </authentication>
  <transaction id="2">
    <meta>
      <property>guid</property>
      <property>name</property>
      <property>enteredBy</property>
      <property>modified</property>
      <property>modifiedBy</property>
    </meta>
    <makeList action="sync" identity="1"/>
  </transaction>
</app>

<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>93</clientId>
    <lastAnchor/>
    <nextAnchor>2002-5-2 23:12:13</nextAnchor>
  </authentication>
  <transaction id="3">
    <meta>
      <property>guid</property>
      <property>name</property>
      <property>make.guid</property>
      <property>enteredBy</property>
      <property>modified</property>
      <property>modifiedBy</property>
    </meta>
    <modelList action="sync" identity="1"/>
  </transaction>
</app>

<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code>
    <systemId>2</systemId>
    <clientId>93</clientId>
    <lastAnchor/>
    <nextAnchor>2002-4-30 20:12:7</nextAnchor>
  </authentication>
  <transaction id="2">
    <meta>
      <property>guid</property>
      <property>year</property>
      <property>make.guid</property>
      <property>model.guid</property>
      <property>enteredBy</property>
      <property>modified</property>
      <property>modifiedBy</property>
      <property></property>
    </meta>
    <vehicleList action="sync" identity="1" offset="0" items="100">
      <year>1985</year>
    </vehicleList>
  </transaction>
</app>



...Client inserts a vehicle with options and ad runs:

<?xml version="1.0" standalone="yes"?> 
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id>
    <code>BZTST27A</code> 
    <systemId>2</systemId>
    <clientId>*PUT YOUR ID HERE*</clientId>
    <lastAnchor/>
    <nextAnchor>2002-04-27 14:30:30</nextAnchor>
  </authentication>
  <transaction id="11">
    <meta>
      <property>guid</property>
    </meta>
    <accountInventory action="insert">
      <guid>10</guid>
      <vehicleGuid>1089</vehicleGuid>
      <enteredBy>2</enteredBy>
      <stockNo>aaa</stockNo>
      <mileage>123</mileage>
      <vin>XCV</vin>
      <sellingPrice>1234</sellingPrice>
      <exteriorColor>red</exteriorColor>
      <condition>condition</condition>
      <comments>additional text</comments>
      <sold>false</sold>
    </accountInventory>
    <inventoryOption action="insert">
      <guid>1</guid>
      <inventoryGuid>10</inventoryGuid>
    </inventoryOption>
    <inventoryOption action="insert">
      <guid>2</guid>
      <inventoryGuid>10</inventoryGuid>
    </inventoryOption>
    <inventoryOption action="insert">
      <guid>3</guid>
      <inventoryGuid>10</inventoryGuid>
    </inventoryOption>
    <inventoryAdRun action="insert">
      <inventoryGuid>10</inventoryGuid>
      <runDate>2002-05-10</runDate>
      <adTypeGuid>3</adTypeGuid>
      <includePhoto>true</includePhoto>
      <enteredBy>10</enteredBy>
    </inventoryAdRun>
    <inventoryAdRun action="insert">
      <inventoryGuid>10</inventoryGuid>
      <runDate>2002-05-17</runDate>
      <adTypeGuid>3</adTypeGuid>
      <includePhoto>false</includePhoto>
      <enteredBy>10</enteredBy>
    </inventoryAdRun>
  </transaction>
</app>
  
...Client requests changes:

<?xml version="1.0" standalone="yes"?> 
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id> 
    <code>BZTST27A</code> 
    <systemId>2</systemId>
    <clientId>*PUT YOUR ID HERE*</clientId>
    <lastAnchor/>
    <nextAnchor>2002-04-27 14:30:30</nextAnchor>
  </authentication>
  <transaction id="12">
    <meta>
      <property>guid</property>
      <property>make_id</property>
      <property>make_name</property>
      <property>etc..</property>
    </meta>
    <makeList action="sync">
      <lastSyncAnchor/>
      <nextSyncAnchor>2002-04-16 15:30:30</nextSyncAnchor>
    </makeList>
  </transaction>
  <transaction id="13">
    <meta>
      <property>guid</property>
      <property>vehicle_id</property>
      <property>make_id</property>
      <property>etc..</property>
    </meta>
    <vehicleList action="sync">
      <lastSyncAnchor/>
      <nextSyncAnchor>2002-04-16 15:30:30</nextSyncAnchor>
    </vehicleList>
  </transaction>
</app>

...Client finalizes sync:

<?xml version="1.0" standalone="yes"?> 
<app>
  <authentication>
    <id>ds21.darkhorseventures.com</id> 
    <code>BZTST27A</code> 
    <systemId>2</systemId>
    <clientId>*PUT YOUR ID HERE*</clientId>
  </authentication>
  <transaction id="14">
    <syncClient action="update">
      <id>*PUT YOUR ID HERE*</id>
      <anchor>20020416155045</anchor>
    </syncClient>
  </transaction>
</app>

